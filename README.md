# UN-R13H ESS Alloy Study

自然言語で記述された自動車ブレーキ法規（UN-R13H 5.2.23 緊急制動表示灯）を題材に、  
**LLM × Alloy（軽量形式手法）** による仕様の未定義領域（＝「行間」）検出を試みた予備実験のリポジトリです。

## 背景

自動車メーカー（OEM）のECU向け自然言語仕様書には、明示されていない条件の組み合わせが存在します。  
これらの「行間」は熟練エンジニアの暗黙知で補完されますが、見落としは実装・試験段階で初めて顕在化します。

本実験では、LLMの世界知識を用いて自然言語仕様から **意味次元** を抽出し、Alloyの SATソルバで直積空間の未定義領域を自動検出する **パイプライン** の実現可能性を検証しました。

## 実験対象

**UN-R13H 5.2.23 緊急制動表示灯（ESS）**

急ブレーキ時にブレーキランプを高速点滅させ、後続車に追突の危険を警告する安全機能です。  
約200語の条文で構成され、OEMの自然言語仕様書に近い粒度を持つ公開文書であるため、予備実験の題材として選定しました。

## パイプライン

```
法規条文 → LLMで意味次元抽出 → LLMでAlloyコード生成 → Alloy SATソルバ実行 → 分類結果の確認・修正
(自然言語)                                                    ← 反復改善ループ (Human-in-the-Loop)
```

直積空間の全パターンに対して、以下4つのステートを導出します。

| ステート | 意味 |
|---|---|
| **Permitted** | 法規条件に合致（点灯/消灯してよい） |
| **Forbidden** | 法規条件に違反（点灯/消灯してはならない） |
| **Conflict** | Permitted と Forbidden が同時に成立（矛盾） |
| **Unspecified** | いずれにも該当しない（未定義＝「行間」） |

## ファイル構成

| ファイル | 状態数 | 概要 |
|---|---|---|
| `01_UNR13H_ESS_Initial.als` | 576 | 初期モデル。LLMが生成したコードをベースに、意味次元の直積空間を全列挙して4分類 |
| `02_UNR13H_ESS_Hysteresis.als` | 1152 | prev（前回信号状態）次元を追加。減速度・予測・ABSの全条件にヒステリシスを実装 |
| `03_UNR13H_ESS_Prioritize_by_or.als` | 1152 | 点灯トリガーのOR回路化。個別条文のForbiddenが出ても、いずれかのトリガーが有効なら上書き |

## 意味次元

約200語の条文から LLM（Gemini Pro 3.0）で抽出した意味次元：

| 意味次元 | 値域 | 根拠条文 |
|---|---|---|
| 主制動装置 | 作動 / 非作動 | 5.2.23 |
| 減速度域 | < 2.5 / 2.5–6.0 / ≥ 6.0 [m/s²] | 5.2.23.1 |
| 制動要求予測 | < 2.5 / 2.5–6.0 / ≥ 6.0 [m/s²] | 5.2.23.2(a) |
| 車速域 | ≤ 50 km/h / > 50 km/h | 5.2.23.2(b) |
| ABS状態 | ABSフルサイクリング / ABS非制御 | 5.2.23.2(b) |
| 設計パターン | 減速度条件のみ / +減速予測 / +ABS / +両方 | 5.2.23.2 |
| ESS信号 | 点灯 / 消灯 | — |

2 × 3 × 3 × 2 × 2 × 4 × 2 = **576 状態**（02以降は prev次元追加で **1152 状態**）

## 発見された3つの「行間」

### 課題a：禁止のNOTの行間（01 → 02）

条文「発動及び停止は…主制動装置の作動によってのみ行う」に対し、LLMは「非作動時は点灯禁止」のみをコーディング。  
その裏にある「非作動時は消灯していてよい」という暗黙の許可を導出できず、非作動＋消灯が Unspecified に。

### 課題b：ヒステリシスの行間（01 → 02）

条文は「6.0 m/s² 以上で点灯可」「2.5 m/s² 未満で消灯」と記述するのみで、**中間帯（2.5–6.0）** の挙動を明示しない。  
LLMは初回モデル化でこの中間帯を見落とし、Alloy の Unspecified が検出。  
prev次元を追加し、ヒステリシス（前回状態の維持）として解消。  
同様の問題は 5.2.23.2(a)（制動要求予測）および 5.2.23.2(b)（ABS条件）にも存在。

### 課題c：OR条件の行間（02 → 03）

5.2.23.1（実測減速度）、5.2.23.2(a)（減速度予測）、5.2.23.2(b)（ABS条件）は独立したトリガーとしてOR結合される構造を条文が暗示するが、明示はされていない。  
LLMは独立条件として実装した結果、例えば「減速度 < 2.5（禁止） vs ABS作動（許可）」のように Conflict が77件発生。  
点灯トリガーをOR回路として合成し、Conflict = 0 に到達。

> LLMが安易にOR結合とせず AND結合とした結果、Alloy の Conflict 検出が正しい要求構造への修正を促した。  
> これは Human-in-the-Loop の設計問題であり、パイプラインのどこに歯止めを置くかが研究課題となる。

## 実行環境

- [Alloy Analyzer](https://alloytools.org/) 6.2.0
- 各 `.als` ファイルを Alloy Analyzer で開き、`run classify_all` で実行

> **注意：** 01 は 576 Cell、02/03 は 1152 Cell を全列挙するため、実行には相応のメモリと時間を要します。

## リサーチクエスチョン

本予備実験から導出されたリサーチクエスチョン：

- **RQ1：** 自然言語仕様に含まれる「行間」を、LLMと軽量形式手法の協調によって顕在化させるための体系的なモデル化手法は何か？
- **RQ2：** パイプライン上、どこに Human-in-the-Loop を構えるべきか？

## ライセンス

MIT License

## 著者

佐藤 浩平
